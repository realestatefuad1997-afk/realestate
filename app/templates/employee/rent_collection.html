{% extends 'base.html' %}
{% block title %}{{ _('Rent Collection') }}{% endblock %}

{% block content %}
<style>
.table thead th { background-color: #f8f9fa; font-weight: 600; }
.table tbody tr:hover { background-color: #f1f5f9; }
.badge-status { padding: 6px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; }
.bg-paid { background: #198754; color: #fff; }
.bg-unpaid { background: #ffc107; color: #212529; }
.bg-nocontract { background: #6c757d; color: #fff; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-cash-coin me-2"></i>{{ _('Rent Collection') }}</h3>
  <div class="text-muted small">
    {{ _('Month starting') }}: {{ month_start }}
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ _('Tenant') }}</th>
        <th>{{ _('Contract') }}</th>
        <th>{{ _('Property') }}</th>
        <th>{{ _('Rent Amount') }}</th>
        <th>{{ _('This Month') }}</th>
        <th>{{ _('Action') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      {% set t = row.tenant %}
      {% set c = row.contract %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>
          <div class="fw-semibold">{{ t.username }}</div>
          <div class="text-muted small">{{ t.email }}</div>
        </td>
        <td>
          {% if c %}
            <span class="badge bg-success">{{ _('Active') }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ _('None') }}</span>
          {% endif %}
        </td>
        <td>
          {% if c %}
            {{ c.property.title }}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
        <td>
          {% if c %}
            {# Fallback to apartment or property price if contract.rent_amount is empty or zero #}
            {% set ra = c.rent_amount %}
            {% if not ra or ra == 0 %}
              {% if c.apartment and c.apartment.rent_price %}
                {{ c.apartment.rent_price }}
              {% elif c.property and c.property.price %}
                {{ c.property.price }}
              {% else %}
                0
              {% endif %}
            {% else %}
              {{ ra }}
            {% endif %}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
        <td>
          {% if c %}
            {% if row.paid_this_month %}
              <span class="badge-status bg-paid">{{ _('Paid') }}</span>
            {% else %}
              <span class="badge-status bg-unpaid">{{ _('Unpaid') }}</span>
            {% endif %}
          {% else %}
            <span class="badge-status bg-nocontract">{{ _('No contract') }}</span>
          {% endif %}
        </td>
        <td>
          {% if c and not row.paid_this_month %}
            <form action="{{ url_for('employee.collect_rent', tenant_id=t.id) }}" method="post" class="d-inline">
              <button class="btn btn-sm btn-success" type="submit">
                {{ _('Mark as Paid') }}
              </button>
            </form>
          {% elif row.paid_this_month %}
            <button class="btn btn-sm btn-outline-success" type="button" disabled>{{ _('Paid') }}</button>
          {% else %}
            <button class="btn btn-sm btn-outline-secondary" type="button" disabled>{{ _('Unavailable') }}</button>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="text-center py-4">{{ _('No data') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
